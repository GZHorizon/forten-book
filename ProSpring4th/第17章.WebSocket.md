# WebSocket

传统的Web应用程序使用标准的HTTP请求/响应功能提供客户端和服务器之间的通信。随着Web的发展，需要更好的交互能力，其中一些需要从服务器进行push/pull或实时更新。随着时间的推移，有多种方法被实现，如连续轮询、长轮询、Comet。每一种都有其优点和缺点，出与这些需要和不足，可以尝试学习WebSocket协议，创建更加简单与健壮的方式来构建交互应用程序。

本章涵盖了WebSocket协议的高级概述和Spring框架为其提供的主要功能。本章涵盖以下主题：

- 介绍WebSocket：我们会对WebSocket协议进行一般性介绍。本部分并不打算对WebSocket协议进行详细讲解，只提供一个高层的介绍。关于此协议的详细资料请参照RFC-6455规范：<http://tools.ietf.org/html/rfc6455>
- 配合Spring来使用WebSocket：在此部分中我们会深入了解一些在Spring框架中使用WebSocket的细节，尤其是使用Spring的WebSocket API、利用SockJS为不支持WebSocket协议的浏览器作一个备选方案。并在SockJS/WebSocket之上使用简单的(或流)面向文本的消息协议（STOMP）来发送消息。

## 17.1 WebSocket简介

WebSocket是作为HTML5规范的组成部分而发展的，允许使用全双工、单套接字的连接来在客户端与服务器之间发送消息。在这部分中，Web应用程序需要定期从服务器端组件获取某些数据实时更新的能力，打开多个连接或使用长轮询。

为双向通信使用WebSocket，避免

使用WebSocket双向通信避免了需要执行HTTP轮询双向　　客户端之间的通信(例如,一个web浏览器)和一个HTTP服务器

使用WebSocket双向通信避免了需要在客户端（如浏览器）与HTTP服务器之间的执行的HTTP双向轮询通信。WebSocket协议的目的是取代所有现有的利用HTTP进行传输的双向通信方式。

WebSocket的单套接字模型带给我们一个更简单的解决方案，避免为每个客户端创建多个连接以便减少开销，例如不需要为每一个消息都发送一个HTTP头。

WebSocket在初次握手时利用HTTP，进行允许它能被使用在标准的HTTP（80）或HTTPS（443）端口上。WebSocket规范定义了ws://和wss://的scheme，指示非安全与安全的连接。

WebSocket协议由两部分组成：客户端与服务器之间的握手，然后传输数据。一个WebSocket连接的创建是在客户端与服务器之间的初次握手时通过从HTTP到WebSocket协议更新请求所创建的，这基于相同的底层TCP/IP连接。在通信的数据传输部分，客户端和服务器可以同时相互发送消息，可以把更强壮的实时通信功能添加到你的应用程序中去。

## 17.2 在Spring中使用WebSocket

从4.0版开始，Spring框架支持WebSocket风格的消息，并把STOMP作为应用程序级别的子协议。在框架中对于WebSocket的支持可以在spring-websocket模块中找到，它兼容Java WebSocket API标准（JSR-356）。

应用程序开发人员还必须认识到，尽管WebSocket带来了新的和令人兴奋的机遇，但不是所有的浏览器都支持此协议。鉴于此原因，为了做得更好，应该使用一些后备技术来模拟此目标的功能实现，以便能让用户在不支持WebSocket协议的浏览器上使用应用程序。为了处理这种情况，Spring框架通过SockJS协议提供了透明的后备选择，我们会在本章后续部分进行讲解。

与服务都是由不同的URL所表示的基于REST的应用程序不同。WebSocket使用一个单独的URL建立最初的握手，数据流是在相同的连接之上。这种类型的消息传递功能比起传统的消息传递系统更重要。在Spring框架4中，如Message这样的基于消息的核心接口已经从Spring Integration项目中迁移到被称为spring-messaging的模块中，以便支持WebSocket风格的消息传递应用程序。

当适合使用STOMP作为应用程序级别的子协议时，我们会讨论这个通过WebSocket传输的协议。WebSocket本身只是一个底层协议，它只是将字节转换为消息。应用程序需要明白通过连接发送的是什么，这就需要使用像STOMP这样的子协议了。在初次握手时客户端和服务器可以使用Sec-WebSocket-Protocol头来定义使用什么样的子协议。虽然Spring框架对STOMP协议提供了支持，但WebSocket并没有任何明确的指定。

现在我们已经了解什么是WebSocket，同时知道Spring提供了什么样的支持，那么我们应该在什么场景下使用这项技术呢？鉴于WebSocket的单套接字的本质以及它可以提供一个连续的双向数据流，WebSocket非常适用于拥有高频率消息传递和要求低延迟通信的应用程序。适合使用WebSocket的应用程序可能包括游戏、实时协作工具、消息传递系统、对时间敏感的价格信息，比如金融资金的更新等等。在设计应用程序时斟酌是否使用WebSocket，你必须考虑消息的频率以及延迟需求因素。这将有助于确定是使用WebSocket技术或是其它传统技术，例如HTTP的长轮询。

### 17.2.1 使用WebSocketAPI

正如本章前面所提及的，WebSocket仅仅将字节转换为消息，并在客户端和服务器之间传输它们。这些消息仍然需要应用程序自己去理解和处理，像STOMP这样的子协议会发挥作用。如果你希望直接使用底层的WebSocket API进行工作，Spring框架提供了一个API来供你使用。当使用Spring的WebSocket API工作时，通常要实现WebSocketHandler接口，或使此接口的实现类，如BinaryWebSocketHandler类用于处理二进制消息，SockJsWebSocketHandler类用于处理SockJS消息，TextWebSocketHandler类用于处理基于字符串的消息。在我们的例子中，为简单起见，我们将使用TextWebSocketHandler通过WebSocket传递字符串消息。我们先来看看如何 利用Spring WebSocket API在底层使用WebSocket获取消息并工作。

如果你愿意，本章的例子也可以通过Java的配置方式进行配置。作者的观点是XML命名空间在表述的明确性方面更简洁，本章将使用此方式。有关使用Java配置的更多信息，请查阅参考手册。

首先让我们把表17-1中的依赖添加以POM.xml中。

**表17-1 WebSocket API的Maven依赖项**

|Group ID|Artifact ID|Version|描述|
|---|---|---|---|
|org.springframework|spring-context|4.0.2|Spring Context模块|
|org.springframework|spring-websocket4.0.2|Spring WebSocket模块|
|org.springframework|spring-webmvc|4.0.2|Spring Web MVC模块|
|org.apache.tomcat|tomcat-websocket-api|7.0.54|Apache Tomcat WebSocket API。在此例子中我们使用Tomcat，这是所需要的容器|
|org.apache.tomcat.embed|tomcat-embed-websocket|7.0.54|嵌入式的Apache Tomcat WebSocket API，我们使用它来运行例子|





